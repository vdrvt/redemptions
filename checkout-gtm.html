<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partner Shop – GTM-only Checkout</title>

    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-5MHX3K7Q');</script>
    <!-- End Google Tag Manager -->

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(130deg, #0f172a 0%, #1d4ed8 100%);
            color: #0f172a;
            min-height: 100vh;
        }
        .wrapper {
            max-width: 720px;
            margin: 0 auto;
            padding: 48px 24px 64px;
        }
        .card {
            background: #ffffff;
            border-radius: 22px;
            padding: 40px 36px;
            box-shadow: 0 26px 60px rgba(15, 23, 42, 0.25);
        }
        h1 {
            font-size: 2.4rem;
            color: #1d4ed8;
            margin-bottom: 18px;
            font-weight: 700;
        }
        p.lead {
            font-size: 1.1rem;
            color: #475569;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        .order-details {
            background: #f8fafc;
            border-radius: 14px;
            padding: 24px;
            margin-bottom: 32px;
            border: 1px solid #e2e8f0;
        }
        .order-details h2 {
            font-size: 1.3rem;
            color: #1f2937;
            margin-bottom: 16px;
        }
        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
            color: #475569;
        }
        .order-item:last-child {
            border-bottom: none;
            font-weight: 700;
            color: #1d4ed8;
            font-size: 1.1rem;
        }
        .pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #dbeafe;
            color: #1d4ed8;
            padding: 8px 12px;
            border-radius: 999px;
            font-size: 0.9rem;
            margin-top: 10px;
        }
        .status-panel {
            margin-top: 30px;
            padding: 22px 24px;
            border-radius: 14px;
            border: 1px solid #1d4ed8;
            background: rgba(29, 78, 216, 0.08);
        }
        .status-panel h3 {
            margin-bottom: 12px;
            font-size: 1.15rem;
            color: #1d3465;
        }
        .status-line {
            margin: 6px 0;
            font-family: 'Courier New', monospace;
            color: #1f2937;
        }
        .status-ok {
            color: #15803d;
            font-weight: 600;
        }
        .status-warn {
            color: #b45309;
            font-weight: 600;
        }
        .cta {
            display: flex;
            flex-wrap: wrap;
            gap: 14px;
            margin-top: 32px;
        }
        .cta a {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 14px 18px;
            border-radius: 12px;
            text-decoration: none;
            font-weight: 600;
            background: #1d4ed8;
            color: #ffffff;
            box-shadow: 0 16px 35px rgba(29, 78, 216, 0.35);
        }
        .cta a.secondary {
            background: #e2e8f0;
            color: #1f2937;
            box-shadow: none;
        }
        .instructions {
            margin-top: 32px;
            background: #0f172a;
            color: #e2e8f0;
            padding: 20px 22px;
            border-radius: 12px;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        .instructions code {
            background: rgba(148, 163, 184, 0.18);
            padding: 2px 6px;
            border-radius: 6px;
        }
        @media (max-width: 640px) {
            .card {
                padding: 28px 22px;
            }
            h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5MHX3K7Q"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <div class="wrapper">
        <div class="card">
            <h1>Checkout – GTM Custom HTML Flow</h1>
            <p class="lead">
                This page relies on a GTM Custom HTML tag to complete the Bondai redemption call. Use it after testing the GTM-only landing page.
            </p>

            <div class="order-details">
                <h2>Order Summary</h2>
                <div class="order-item">
                    <span>Order ID</span>
                    <span>A123456</span>
                </div>
                <div class="order-item">
                    <span>Currency</span>
                    <span>USD</span>
                </div>
                <div class="order-item">
                    <span>Total</span>
                    <span>$79.99</span>
                </div>
                <div class="pill">
                    MID: <span id="mid-display">loading…</span>
                </div>
            </div>

            <div class="status-panel" id="gtm-status">
                <h3>Bondai Redemption Status</h3>
                <div class="status-line">Status: <span class="status-warn" id="status-text">waiting for GTM</span></div>
                <div class="status-line">Response:</div>
                <pre class="status-line" id="status-response">No response yet. Custom HTML tag should call window.updateBondaiStatus(result).</pre>
            </div>

            <div class="instructions">
                <strong>GTM TODO:</strong>
                <ol>
                    <li>Use the <code>bondai_redemption_ready</code> event in GTM to trigger your Custom HTML tag.</li>
                    <li>Call the Bondai API from the tag (via the Netlify function or your proxy) and finally invoke <code>window.updateBondaiStatus(result)</code>.</li>
                    <li>Optionally push <code>{ event: 'bondai_redemption_completed', result }</code> back into <code>dataLayer</code> for analytics.</li>
                </ol>
            </div>

            <div class="cta">
                <a href="/landing-gtm.html">Back to GTM landing</a>
                <a href="/index.html" class="secondary">Choose different flow</a>
            </div>
        </div>
    </div>

    <script>
        (function () {
            window.dataLayer = window.dataLayer || [];

            function getCookie(name) {
                var nameEQ = name + "=";
                var ca = document.cookie.split(';');
                for (var i = 0; i < ca.length; i++) {
                    var c = ca[i];
                    while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                    if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
                }
                return null;
            }

            function getMid() {
                var fromCookie = getCookie('bondai_mid');
                if (fromCookie) {
                    return fromCookie;
                }
                try {
                    var stored = localStorage.getItem('bondai_mid');
                    if (stored) {
                        return stored;
                    }
                } catch (error) {
                    console.warn('[bondai] Unable to access localStorage', error);
                }
                return null;
            }

            function setStatus(result) {
                var statusEl = document.getElementById('status-text');
                var responseEl = document.getElementById('status-response');
                var ok = !!(result && result.ok);

                statusEl.textContent = ok ? 'success' : 'failed';
                statusEl.className = ok ? 'status-ok' : 'status-warn';
                try {
                    responseEl.textContent = JSON.stringify(result, null, 2);
                } catch (error) {
                    responseEl.textContent = '[unable to render response]';
                }
            }

            window.updateBondaiStatus = function (result) {
                setStatus(result || { ok: false, errors: [{ message: 'Empty result provided.' }] });
            };

            var mid = getMid();
            var midEl = document.getElementById('mid-display');
            if (mid) {
                midEl.textContent = mid;
            } else {
                midEl.textContent = 'Unavailable';
                document.getElementById('status-response').textContent = 'No MID found; ensure landing flow stored it before checkout.';
            }

            var redemptionPayload = {
                member_partner_key: mid || null,
                timestamp: new Date().toISOString(),
                offer_amount: 79.99,
                offer_savings_amount: 10.0
            };

            window.dataLayer.push({
                event: 'purchase',
                value: 79.99,
                currency: 'USD',
                transaction_id: 'A123456'
            });

            window.dataLayer.push({
                event: 'bondai_redemption_ready',
                payload: redemptionPayload
            });
        })();
    </script>
</body>
</html>


